name: Build and test

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:
    inputs:
        dummy:
            required: false
            type: boolean

permissions:
  contents: read
  checks: write

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --user root --workdir /
    steps:
      - name: Update and install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -Sy --noconfirm python python-pip python-pytest qt6-declarative coreutils nodejs npm python-build wget python-coverage

      - name: Checkout
        uses: actions/checkout@v3

      - name: Get bundled qmldom
        run: |
          wget https://github.com/SanderVocke/qoverage/releases/download/qmldom-6.5.2-v1.0.0/qmldom-3.6.2-linux-x64
          mkdir -p qoverage/bundled_qmldom
          mv qmldom-3.6.2-linux-x64 qoverage/bundled_qmldom/qmldom
          chmod a+x qoverage/bundled_qmldom/qmldom

      - name: Build
        run: |
            python -m build -w .
            echo "wheel_path=$(ls dist/*.whl)" | tee -a $GITHUB_ENV
            cd dist && echo "wheel_filename=$(ls *.whl)" | tee -a $GITHUB_ENV

      - name: Upload wheel
        if: ${{ !env.ACT }}
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.wheel_filename }}
          path: ${{ env.wheel_path }}
      
      - name: Install wheel
        run: |
          python -m pip install --break-system-packages dist/*.whl
    
      - name: Run Tests With Coverage
        shell: bash
        run: >
          mkdir -p /tmp/generated &&
          QT_ASSUME_STDERR_HAS_CONSOLE=1
          OUTPUT_DIR=/tmp/generated
          QOVERAGE_LOGLEVEL=debug
          QOVERAGE="python -m coverage run --append --source=qoverage -m qoverage"
          DUMP_RUN_LOG=1
          QT_QPA_PLATFORM=vnc
          QML=/usr/lib/qt6/bin/qml
          python -m coverage run --append --source=qoverage -m pytest test --junit-xml=pytest.xml
      
      - name: Generate Pytest coverage report
        run: |
          python -m coverage xml -i -o coverage.xml

      - name: Upload generated code
        if: ${{ (success() || failure()) && !env.ACT }}
        uses: actions/upload-artifact@v3
        with:
          name: generated_code
          path: /tmp/generated

      - name: Publish Python Test Report
        if: ${{ (success() || failure()) && !env.ACT }}
        uses: mikepenz/action-junit-report@v3
        with:
            report_paths: pytest.xml
            detailed_summary: true
            include_passed: true
            check_name: 'pytest'

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v3
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
